---
title: "NYC Shooting Incidents Analysis (2006-2022)"
author: "LR"
date: "2023-07-10"
output:
  html_document:
    df_print: paged
  pdf_document: default
editor_options: 
  markdown: 
    wrap: 72
---
# DTSA 5301 â€“ DATA SCIENCE AS A FIELD.-
# WEEK 5.- FINAL PROJECT 1.-
# "NYPD Shooting Incident Data Report"

## READ ME FIRST

# Libraries:

This document requires the following libraries: 

library( "tidyverse")

library("dplyr") 

library("ggplot2") 

library("lubridate")

library("viridis")

# Data Source:

The data contains Shooting Incidents in New York city between 2006 and
2022. It was sourced from the official Government website
<https://catalog.data.gov/datase>, in csv format from the following
link:
<https://data.cityofnewyork.us/api/views/833y-fsy8/rows.csv?accessType=DOWNLOAD>

The code is written to download and save the data in the same directory
of the .RMD file, with the name "nypdCleanMaster.csv".
I you choose to download the file manually, it must be saved downloaded in the directory in which "Week5NYPDRev0.Rmd" is located.

# Introduction:

This document presents the analysis and results of the Shooting
Incidents (SI) data obtained from the City of New York between 2006 and
2022. The goals and questions I would like to answer are presented at
the beginning of the document, followed by the answers to the questions
which are also the conclusions. This section looks rather long since it is here where the visualizations and comments are presented.
After importing and tiding the data, I follow the iterative "Transform - Visualize - Model process". 
The results are presented clean, with the code in Attachments. The attachments
provide the details, logic, and commented code to support all
computations and graphs for all sections. There have been sharp
variations in SI in recent years. I often use long-run averages, and
compare them to recent years (2022 mostly) to test current relevance.

# Goals: 

The overarching goal is to inform an interested audience about shooting incidents in New York city.

The broad audience may be parents (send kids to school), people who live there, tourists who visit, and the even the police. The (hypothetical) interested user wants to explore the existing SI data available to get a
better feel of how safe the city is, and compare it with anecdotal information gathered from conversations with colleagues, friends, family, and the media. For the purpose of this assignment I will focus on that segment of the audience who are visitors to the city.

The overarching question is "What are the places and times most affected by Shooting Incidents in NYC?" This broad question may be broken down into more specific questions:

1) Is there a trend for the number of Shooting Incidents (SI) over the years 2006-2022? Is it trending down or up? Has it been consistently doing so?

2) What is the number of SI in 2022 for each of the different neighborhoods (boros)?

3) Is there a monthly trend or pattern? What month in 2022 shows the highest number of SI in each boro? How many SI took place in that month?

4) How many SI in the highest month of 2022 resulted in the murder of the victim?

5) Is there a day in the week when SI is higher? What day/s are higher?

6) What is the long-run average of daily SI for each day of the week? 

7) What is the daily average pattern of FATAL shooting incidents?

8) Is there a pattern of SI in the hour of the day?

9) What are the most active hours for fatal shooting incidents?

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library( "tidyverse")
library("dplyr")
library("ggplot2")
library("lubridate")
library("viridis")

printMyDF <- function( DF ){
        cat( "\n..\n")
        print( str( DF  ) )
        cat( "\n..\n")
        print( head( DF  ))
        cat( "\n..\n")
        print( tail( DF ) )
        cat( "\n..\n")
}

formatFigures <- function( targetFigure ){
        format( round( targetFigure, 0), nsmall=0, big.mark = "," )
}

```

# A note on Biases: 

The data includes the COVID-19 pandemic years (2019 through 2021). However, it does not include information on direct or indirect effects of it; for example, a reduction of police patrols (if any reduction existed) could have provided a less controlled environment where SI could have increased.
Zip codes are known to introduce bias since they are proxies for race. I will be using the name of the boros in the analysis, which in some way are connected with zip codes.
On the technical side, my personal bias is a tendency to overfit models. I mitigate that bias using a training, a testing set and, and an out-of-sample set. I have found through time that reducing the error on the training set (by over fitting it for example) does not necessarily lead to better results (lower error) on testing and out-of-sample sets. I have not gone to that extent in this case. I have used one training set
and produced the best regression model (best/highest R-squared) I could get in 5
iterations.

```{r Attach1, include=TRUE, echo=FALSE, message= FALSE,  warning = FALSE }
# Attachment 1: Importing and cleaning the data.
#===================================================================================================================================
# Importing the Data.
#===================================================================================================================================

# NYPD link
# https://data.cityofnewyork.us/api/views/833y-fsy8/rows.csv?accessType=DOWNLOAD
# fields explained:
# https://data.cityofnewyork.us/Public-Safety/NYPD-Shooting-Incident-Data-Historic-/833y-fsy8

urlNYPD <- "https://data.cityofnewyork.us/api/views/833y-fsy8/rows.csv?accessType=DOWNLOAD"
origNypdDF <- read.csv(urlNYPD) %>% as.data.frame()
orignames <- names(origNypdDF)
names(origNypdDF) <- c("key","date","time","boro","location","precint","jurcode","locclass","locdesc","murflag","perpage","perpsex","perprace", "vicage","vicsex","vicrace","x","y","lat","long","lonlat")

# Wrangling and cleaning: 
# Go over the variables one by one, clean them up, and break them up 
# into further pieces as needed (dates and time for example).
# Read the data source documentation.

# I dont need the precise coordinates. Remove lat and lon.
nypdDF <- origNypdDF[,-which( names(origNypdDF) %in% c("x", "y", "lat","long","lonlat" ) )] 

# fix dates format.
nypdDF$date <- nypdDF$date %>% as.Date("%m/%d/%Y")
# break year, month, and weekday.
nypdDF$year <- nypdDF$date %>% format("%Y") %>%  as.numeric() # as.factor()
nypdDF$yearmonth <- nypdDF$date %>% format("%Y%m") %>%  as.numeric() # %>% as.factor()
nypdDF$month <- nypdDF$date %>% format("%m") %>%  as.numeric() # %>% as.factor()
nypdDF$weekDay <- nypdDF$date %>% weekdays() %>% as.factor()

# fix time format.
nypdDF$time <- nypdDF$time %>% hms()
# I will use the hour for my analysis. 3 will be the hour between 3 and 3.59.
nypdDF$hourD <-  nypdDF$time[]@hour %>% as.numeric() #as.factor()

nypdDF <- nypdDF[, c(1,2,17:20,3,21,4:16)]

# set boro and other variables as factors.
nypdDF[,c(9:21)]<- lapply( nypdDF[,c(9:21)], as.factor ) # apply the function as.factor() to these columns.

# set jurisdiction level names to 0: Patrol, 1:Transit, 2: Housing 
# I will assign the 2 NAs here to the patrol category.
levels( nypdDF$jurcode) <- c("Patrol", "Transit", "Housing")
nypdDF$jurcode[ which( is.na(nypdDF$jurcode) == TRUE ) ] <- "Patrol"

# location classification: most of the rows are unkwon (not classified).
levels(nypdDF$locclass)[1] <- "unkwon"

# location description: most of the rows are unkwon (not classified).
levels(nypdDF$locdesc)[c(1,2,28)] <- "unkwon"
levels(nypdDF$locdesc)[c(2,3,8,24)] <- "BankLike"
levels(nypdDF$locdesc)[c(4:9,11:12,14:17,20:21,24,28:29,32:36)] <- "StoreLike"
levels(nypdDF$locdesc)[c(3,12,14)] <- "BarLike"
levels(nypdDF$locdesc)[c(6,13)] <- "WarehouseLike"

# Perpetrator details:
levels(nypdDF$perpage)[c(1,2,4,6,10,11)] <- "unknown"
levels(nypdDF$perpsex)[c(1,2,5)] <- "unknwon"
levels(nypdDF$perprace)[c(1,2,7)] <- "unknwon"

# Victim details:
levels(nypdDF$vicage)[c(2,7)] <- "unknwon"
levels(nypdDF$vicrace)[5] <- "unknwon"

#str( nypdDF)
#summary( nypdDF)
# Now we have a clean DF.
#===================================================================================================================================

```

```{r Attach2A, include=TRUE, echo=FALSE, message= FALSE,  warning = FALSE, results="hide", dev='png', fig.show='hide'}

# Attachment 2: Analysis

nyCrimeYearly <- nypdDF %>% group_by( year, boro, murflag ) %>% summarize( incidents = n())

plot2 <- ggplot( data=nyCrimeYearly, aes( x=year, y=incidents, fill=murflag ) ) +
                geom_bar(stat="identity")+
                labs(title= "NYC Shooting Incidents (2006-2022) - Murder breakdown.", fill="Murder Occured")+
theme(legend.position = "bottom", plot.title.position = 'plot', plot.title = element_text(hjust = 0.5))+
scale_fill_viridis_d(option="viridis")
  #scale_fill_manual(values=c("darkorange", "darkviolet"))


plot(plot2)

# Shooting incidents steadily declined from a high of 
stat1 <- sum( nyCrimeYearly$incidents[ nyCrimeYearly$year=="2006"] ) %>% formatFigures()
#stat1
# in 2006 -- of which
stat2 <- sum( nyCrimeYearly$incidents[ nyCrimeYearly$year=="2006" & nyCrimeYearly$murflag=="true"] ) %>% formatFigures()
#stat2
# where categorized as murders--
# to a low of 
stat3 <- sum( nyCrimeYearly$incidents[ nyCrimeYearly$year=="2019"] ) %>% formatFigures()
#stat3
# in 2019, -- with
stat4 <- sum( nyCrimeYearly$incidents[ nyCrimeYearly$year=="2019" & nyCrimeYearly$murflag=="true"] ) %>% formatFigures()
#stat4
# murders.-
# Shooting incidents increased sharply to double in 2020 and 2021 to 
stat5 <- sum( nyCrimeYearly$incidents[ nyCrimeYearly$year=="2021"] ) %>% formatFigures()
#stat5
# in 2021 --which included 
stat6 <- sum( nyCrimeYearly$incidents[ nyCrimeYearly$year=="2021" & nyCrimeYearly$murflag=="true"] ) %>% formatFigures()
#stat6
# murders.

```

```{r Attach2B, include=TRUE, echo=FALSE, message= FALSE,  warning = FALSE, results="hide", dev='png', fig.show='hide'}

nyCrimeYearly3 <- nypdDF %>% group_by( year, boro ) %>% summarize( incidents = n())

#plot3 <- ggplot( data=nyCrimeYearly3, aes( x=year, y=incidents, fill=boro ) ) +
#                geom_bar(stat="identity")+
#                labs(title= "NYC Shooting Incidents (2006-2022)-Boro breakdown.", fill="Boro")+
#                theme(legend.position = "bottom", plot.title.position = 'plot', plot.title = element_text(hjust = 0.5)) +
#  scale_fill_viridis_d(option="magma")
#plot(plot3)

plot3 <- ggplot( data=nyCrimeYearly3) +
                geom_point( aes( x=year, y=incidents, color=boro, shape=boro, size=incidents), stroke=1)+
                labs(title= "NYC Shooting Incidents (2006-2022)-Boro breakdown.", fill="black")+
                theme(legend.position = "bottom", 
                      plot.title.position = 'plot', 
                      plot.title = element_text(hjust = 0.5),
                      panel.background = element_rect(fill = "lightgrey")) +
                scale_color_viridis_d(option="magma")
plot(plot3)

# The boro with the largest number of current (2022) shooting incidents is:
nyCrimeBoro2022 <- nyCrimeYearly[nyCrimeYearly$year=="2022", ] %>% pivot_wider(names_from = murflag, values_from = incidents)
nyCrimeBoro2022$total <- nyCrimeBoro2022$false + nyCrimeBoro2022$true
nyCrimeBoro2022$trueProp <- (nyCrimeBoro2022$true/nyCrimeBoro2022$total * 100) %>% round(0)
nyCrimeBoro2022

indexMaxBoro <- which( nyCrimeBoro2022$total == max(nyCrimeBoro2022$total) )
indexMaxBoroMur <- which( nyCrimeBoro2022$true == max(nyCrimeBoro2022$true) )

#nyCrimeBoro2022[ indexMaxBoro, ]

stat7 <- nyCrimeBoro2022$boro[ indexMaxBoro ]
# Brooklyn, with
stat8 <- nyCrimeBoro2022$total[indexMaxBoro]
# total incidents, and 
stat9 <- nyCrimeBoro2022$true[indexMaxBoro]
# incidents classified as murders.

# The boro with the largest percentage of fatal shooting incidents is:
indexMaxProp <- which( nyCrimeBoro2022$trueProp == max(nyCrimeBoro2022$trueProp) )
#nyCrimeBoro2022[ indexMaxProp, ]
stat10 <- nyCrimeBoro2022$boro[ indexMaxProp ]
# Bronx, with
stat11 <- nyCrimeBoro2022$total[indexMaxProp]
# total incidents, and 
stat12 <- nyCrimeBoro2022$true[indexMaxProp]
# incidents classified as murders.
stat13 <- nyCrimeBoro2022$trueProp[indexMaxProp] %>% round(0)
# 23% of total incidents in the boro.

```

```{r Attach2C1, include=TRUE, echo=FALSE, message= FALSE,  warning = FALSE, results="hide", dev='png', fig.show='hide'}

# Month Analysis / Breakdown.
# Most active months for shooting incidents:
nyYearMonth <- nypdDF %>% group_by( year, month, murflag) %>% summarize( incidents = n())
nyYearMonth <- nyYearMonth %>% pivot_wider(names_from = murflag, values_from = incidents)
nyYearMonth$total <- nyYearMonth$false + nyYearMonth$true

#str(nyYearMonth)
#summary(nyYearMonth)

plot4 <- ggplot( data=nyYearMonth ) +
                geom_point( aes( x=year, y=month, color=total, size=total) )+
                scale_y_continuous(breaks = c(1:12), labels = c(1:12))+
                scale_x_continuous(breaks = c(2006:2022), labels = c(2006:2022))+
  labs(title= "NYC Total Shooting Incidents (2006-2022)- Year/Month breakdown.",fill="total")+
                theme(legend.position = "bottom", 
                      plot.title.position = 'plot', 
                      plot.title = element_text(hjust = 0.5),
                      panel.background = element_rect(fill = "lightgrey") )+
                scale_color_viridis( option= "magma")

plot(plot4)

```

```{r Attach2C2, include=TRUE, echo=FALSE, message= FALSE,  warning = FALSE, results="hide", dev='png', fig.show='hide'}

# The top 5 months of the year when shooting incidents are higher are:
# This is the average shooting incidents over 17 years, agreggated monthly.
# On average, incident shootings are higher in these months.
tempDF1 <- nypdDF %>% group_by(year, month) %>% summarize( incidents = n())

tempDF1 <- tempDF1 %>% pivot_wider(names_from = month, values_from = incidents)
month <- names(tempDF1)[2:length(names(tempDF1))] %>% as.numeric()
#month
meanInc <- colMeans( tempDF1 )[2:length(names(tempDF1))] %>% round(0)
#meanInc
avIncYear <- mean(meanInc)
maxMonthDF <- cbind(month,meanInc) %>% as.data.frame()

#maxMonthDF

tempDF11 <- nypdDF %>% group_by(month, year) %>% summarize( incidents = n())
plot51 <- ggplot( data = tempDF11, aes( x = as.character(month), y = incidents, color=year ) ) +
                geom_boxplot( width=0.5, notch=FALSE, varwidth=TRUE, alpha=1, color="darkblue", fill="darkgrey" )+
                #geom_violin( width=1.4, alpha= 0.2)+
                geom_jitter(width = 0.2, size=1.5)+
                geom_hline( yintercept = avIncYear, linetype="dashed", color="red", size=1)+
                scale_x_discrete(limits = as.character( seq( from=1,to=12,by=1) ) )+
                scale_y_continuous(breaks = seq(from=0,to=400,by=50), labels = seq(from=0,to=400,by=50))+
                theme( legend.position="bottom",
                       panel.background = element_rect(fill = "grey") )+
                #scale_fill_viridis( option="magma")+
                scale_color_viridis( option="magma")+
                labs( title= "NYC Total Shooting Incidents (2006-2022) -- SI by Month.", x = "Months", y = "Incidents")
plot(plot51)
# https://ggplot2.tidyverse.org/reference/geom_boxplot.html

# the top 5 months of the year when shooting incidents are higher are:
stat14 <- maxMonthDF[ (order( maxMonthDF$meanInc , decreasing = TRUE)), ][1:5,1]
# These 5 months are above the long run annual average of:
stat15 <- avIncYear
```

```{r Attach2C3, include=TRUE, echo=FALSE, message= FALSE,  warning = FALSE, results="hide", dev='png', fig.show='hide'}

# In the year 2022:
tempDF2 <- nypdDF[nypdDF$year=="2022",] %>% group_by(month) %>% summarize( incidents = n())

tempDF2 <- tempDF2 %>% pivot_wider(names_from = month, values_from = incidents)
month2 <- names(tempDF2)[1:length(names(tempDF2))] %>% as.numeric()
#month2
meanInc2 <- colMeans( tempDF2 )[1:length(names(tempDF2))] %>% round(0)
meanInc2
avIncYear2 <- mean(meanInc2)
maxMonthDF2 <- cbind(month2,meanInc2) %>% as.data.frame()

plot6 <- ggplot( data=maxMonthDF2 ) +
                geom_point( aes( x=month2, y=meanInc2, size=meanInc2, color=meanInc2) )+
                geom_hline(yintercept=avIncYear2, linetype="dashed", color="red", size=1)+
                scale_x_continuous(breaks = c(1:12), labels = c(1:12))+
                scale_y_continuous(breaks = c(50,75,100,125,150,175,200,225,250), labels = c(50,75,100,125,150,175,200,225,250))

#plot(plot6)

# this plot is not rendering correctly. Mixing with rendition of 2c4.
#maxMonthDF2

stat16 <- maxMonthDF2[ (order( maxMonthDF2$meanInc , decreasing = TRUE)), ][1:5,1]

stat17 <- avIncYear2
```

```{r Attach2C4, include=TRUE, echo=FALSE, message= FALSE,  warning = FALSE, results="hide", dev='png', fig.show='hide'}

# and focusing on those incidents resulting in murder in 2022:
tempDF3 <- nypdDF[ (nypdDF$year == "2022" & nypdDF$murflag == "true" ), ] %>% group_by(month) %>% summarize( incidents = n())

avIncYear3 <- mean(tempDF3$incidents)

plot7 <- ggplot( data=tempDF3 ) +
                geom_point( aes( x=month, y = incidents, size=incidents, color=incidents) )+
                geom_hline(yintercept=avIncYear3, linetype="dashed", color="red", size=1)+
                scale_x_continuous(breaks = c(1:12), labels = c(1:12))+
                scale_y_continuous(breaks = seq(from=10,to=55,by=5), labels = seq(from=10,to=55,by=5))+
                labs(title= "NYC Fatal Shooting Incidents (2022)- Month breakdown.", x = "Month", y = "Fatal Incidents", color="", size="")+
                theme(legend.position = "bottom", 
                      plot.title.position = 'plot', 
                      plot.title = element_text(hjust = 0.5),
                      panel.background = element_rect(fill = "grey") )+
                scale_color_viridis( option="magma")
plot(plot7)


stat18 <- tempDF3[ (order( tempDF3$incidents , decreasing = TRUE)),][1:5 , 1] %>% as.data.frame() %>% .[,1]
stat19 <- avIncYear3 %>% round(0)

# the pattern in murder cases is similar to that of the entire shooting incidents.

```

```{r Attach2C50, include=TRUE, echo=FALSE, message= FALSE,  warning = FALSE, results="hide", dev='png', fig.show='hide'}

nyYearWeek <- nypdDF %>% group_by( year, weekDay, murflag) %>% summarize( incidents = n())
nyYearWeek <- nyYearWeek %>% pivot_wider(names_from = murflag, values_from = incidents)
nyYearWeek$total <- nyYearWeek$false + nyYearWeek$true


tempDF81 <- nypdDF %>% group_by(weekDay, year) %>% summarize( incidents = n())
weekXaxis <- unique( tempDF81$weekDay )[c(2,6,7,5,1,3,4)]
#weekXaxis

avIncWeedDay81 <- mean(tempDF81$incidents) %>% round(0)

plot81 <- ggplot( data = tempDF81, aes( x = weekDay, y = incidents, color = year ) )+
                geom_boxplot( width=0.5, notch=FALSE, varwidth=TRUE, alpha=1, color="darkblue", fill="darkgrey" )+
                geom_hline( yintercept = avIncWeedDay81, linetype="dashed", color="red", size=1)+
                geom_jitter(width = 0.2, size=1.5)+
                scale_x_discrete( limits = weekXaxis )+
                theme(legend.position = "bottom", 
                      plot.title.position = 'plot', 
                      plot.title = element_text(hjust = 0.5),
                      panel.background = element_rect(fill = "grey") )+
                scale_color_viridis( option="magma")+
                labs(title= "NYC Total Shooting Incidents by Weekday-Year (2006-2022).", x="", y="Total Incidents", color="", size="")
plot( plot81 )

#nyYearWeek
# The most active days for shooting incidents have been Saturday, Sundays, and Mondays.

```

```{r Attach2C51, include=TRUE, echo=FALSE, message= FALSE,  warning = FALSE, results="hide", dev='png', fig.show='hide'}
tempDF4 <- nypdDF %>% group_by(year, weekDay) %>% summarize( incidents = n())

tempDF4 <- tempDF4 %>% pivot_wider(names_from = weekDay, values_from = incidents)
# now I have the total number of incidents year by year, by each day of the week.
#tempDF4
# The average weekday number of incidents is the total incident number divided
# by the number of mondays (tuesdays, ,.... sundays) in that year.
# Let's compute that.

#unique(nypdDF$year)
startDate <- as.Date("01/01/2006", format= "%m/%d/%Y" )
endDate <- as.Date("12/31/2022", format= "%m/%d/%Y" )
datesSeq <- seq(from=startDate,to=endDate,by="days")
yearSeq <- datesSeq %>% format("%Y") %>% as.numeric()
weekdaySeq <- datesSeq %>% weekdays() %>% as.character()
#countSeq <- rep( 1, length(startDate) ) %>% as.numeric()
calDF <- data.frame( yearSeq,weekdaySeq )
calDF <- calDF %>% group_by(yearSeq,weekdaySeq) %>% summarize(countSeq=n())

calDF <- calDF %>% pivot_wider( names_from = weekdaySeq, values_from=(countSeq))
calDF <- calDF[,c(1,7,3,8,2,6,4,5)]
tempDF4[,2:8] <- (tempDF4[,c(2:8)]/calDF[,c(2:8)]) %>% round(1)
#tempDF4

weekDay <- names(tempDF4)[2:length(names(tempDF4))]

meanIncW <- colMeans( tempDF4 )[2:length(names(tempDF4))] %>% round(1)
#meanIncW 

avIncWeek <- mean(meanIncW)

#weekDay
weekDayNum <- c(5,1,6,7,4,2,3) # 1 for Monday, 7 for Sunday.
maxWeekDF <- cbind(weekDayNum,meanIncW) %>% as.data.frame()

#maxWeekDF

plot9 <- ggplot( data=maxWeekDF ) +
                geom_point( aes( x=weekDayNum, y=meanIncW, size=meanIncW, color=meanIncW) )+
                geom_hline(yintercept=avIncWeek, linetype="dashed", color="red", size=1)+
                scale_x_continuous(breaks = c(1:7), labels = c(1:7))+
                scale_y_continuous(breaks = seq(from=0,to=10,by=1), labels = seq(from=0,to=10,by=1) )+
  labs(title= "NYC Shooting Incidents - Weekday Long-run Average (2006-2022).", x = "Weekday (1 for Monday)", y = "Mean Incidents in a Day", color="", size="")+
                theme(legend.position = "bottom", 
                      plot.title.position = 'plot', 
                      plot.title = element_text(hjust = 0.5),
                      panel.background = element_rect(fill = "grey") ) +
                scale_color_viridis( option="magma")
plot(plot9)

# These weekdays have the largest number of shooting incidents:
stat20 <- maxWeekDF[ (order( maxWeekDF$meanIncW , decreasing = TRUE)), ][1:4,1]
stat21 <- avIncWeek %>% round(1)
# Sunday, Saturday, Monday.

```

```{r Attach2C6, include=TRUE, echo=FALSE, message= FALSE,  warning = FALSE, results="hide", dev='png', fig.show='hide'}
# The weekly pattern for shooting incidents resulting in murder:
tempDF5 <- nypdDF[ nypdDF$murflag == "true", ] %>% group_by(year, weekDay) %>% summarize( incidents = n())

tempDF5 <- tempDF5 %>% pivot_wider(names_from = weekDay, values_from = incidents)
tempDF5[,2:8] <- (tempDF5[,c(2:8)]/calDF[,c(2:8)]) %>% round(1)

#tempDF5

meanIncW5 <- colMeans( tempDF5 )[2:length(names(tempDF5))] %>% round(1)
#meanIncW5 

avIncWeek5 <- mean(meanIncW5)

maxWeekDF5 <- cbind( weekDayNum, meanIncW5 ) %>% as.data.frame()

#maxWeekDF5

plot10 <- ggplot( data = maxWeekDF5 ) +
                geom_point( aes( x=weekDayNum, y=meanIncW5, size=meanIncW5, color=meanIncW5) )+
                geom_hline( yintercept=avIncWeek5, linetype="dashed", color="red", size=1 )+
                scale_x_continuous( breaks=c(1:7), labels = c(1:7))+
                scale_y_continuous( breaks=seq( from=0, to=2, by=0.1), labels=seq( from=0, to=2, by=0.1 ) )+
                labs( title = "NYC Fatal Shooting Incidents - Weekday Long-run Average (2006-2022).", x = "Weekday (1 for Monday)", y = "Mean Fatal Incidents in a Day", color="", size="")+
                theme(legend.position = "bottom", 
                      plot.title.position = 'plot', 
                      plot.title = element_text(hjust = 0.5),
                      panel.background = element_rect(fill = "grey") ) +
                scale_color_viridis( option="magma")
plot(plot10)

# These weekdays have the largest number of shooting incidents resulting in
# in murder: Sunday, Saturday, Monday.
stat22 <- maxWeekDF5[ (order( maxWeekDF5$meanIncW5 , decreasing = TRUE)), ][1:4,1]
stat23 <- avIncWeek5 %>% round(1)

```

```{r Attach2C70, include=TRUE, echo=FALSE, message= FALSE,  warning = FALSE, results="hide", dev='png', fig.show='hide'}
tempDF6 <- nypdDF %>% group_by(weekDay, hourD) %>% summarize( incidents = n())

plot11 <- ggplot( data = tempDF6 ) +
                geom_point( aes( x=hourD , y=weekDay, size=incidents, color=incidents ) )+
                scale_x_continuous(breaks = c(0:23), labels = c(0:23))+
  scale_y_discrete( limits = weekXaxis )+
                labs(title= "NYC Shooting Incidents (2006-2022) - Weekday-Hour breakdown.", x = "Hour of the Day", y = "", color="", size="" )+
                theme(legend.position = "right", 
                      plot.title.position = 'plot', 
                      plot.title = element_text(hjust = 0.5),
                      panel.background = element_rect(fill = "grey") )+
                scale_color_viridis( option="magma")
  
plot(plot11)

```

```{r Attach2C71, include=TRUE, echo=FALSE, message= FALSE,  warning = FALSE, results="hide", dev='png', fig.show='hide'}

tempDF61 <- nypdDF %>% group_by(hourD) %>% summarize( incidents = n())

avIncH <- mean( tempDF61$incidents) %>% round(0)

scaleMax61 <- (max( tempDF61$incidents) *1.1 )%>% round(-2)
plot12 <- ggplot( data = tempDF61 ) +
                geom_point( aes( x = hourD, y=incidents, size=incidents, color=incidents) )+
                geom_hline( yintercept=avIncH, linetype="dashed", color="red", size=1 )+
                scale_x_continuous( breaks=c(0:23), labels = c(0:23))+
                scale_y_continuous( breaks=seq( from=0, to=scaleMax61, by=250), 
                                    labels=seq( from=0, to=scaleMax61, by=250 ) )+
                labs(title= "NYC Total Shooting Incidents by Hour Of The Day (2006-2022).", x = "Hour of the Day", y = "Incidents",  color="", size="" )+
                theme(legend.position = "bottom", 
                        plot.title.position = 'plot', 
                        plot.title = element_text(hjust = 0.5),
                        panel.background = element_rect(fill = "grey") )+
                scale_color_viridis( option="magma")
plot(plot12)

maxHourList61 <- tempDF61[ (order( tempDF61$incidents , decreasing = TRUE)), ] %>% as.data.frame() %>% .[1:4,1]

```

```{r Attach2C72, include=TRUE, echo=FALSE, message= FALSE,  warning = FALSE, results="hide", dev='png', fig.show='hide'}

# The most active hours for FATAL shooting incidents:
tempDF7 <- nypdDF[ nypdDF$murflag == "true", ] %>% group_by(hourD) %>% summarize( incidents = n())

avIncH7 <- mean( tempDF7$incidents )
maxScale7 <- (max( tempDF7$incidents )*2) %>% round(-2)

# The most active hours for fatal shooting incidents are:
maxIncH7 <- tempDF7[ (order( tempDF7$incidents, decreasing = TRUE)), ][1:5,1] %>% as.data.frame() %>% .[,1]

plot13 <- ggplot( data = tempDF7 ) +
                geom_point( aes( x = hourD, y = incidents, size = incidents,  color = incidents) )+
                geom_hline( yintercept = avIncH7, linetype = "dashed", color = "red", size = 1 )+
                scale_x_continuous( breaks=c(0:23), labels = c(0:23))+
                scale_y_continuous( breaks=seq( from=0, to=maxScale7, by=50), labels=seq( from=0, to=maxScale7, by=50 ) )+
                labs(title= "NYC Fatal Shooting Incidents by Hour - (2006-2022).", x = "Hour of the Day", y = "Fatal Incidents",  color="", size="" )+
                theme(  legend.position = "bottom", 
                        plot.title.position = 'plot', 
                        plot.title = element_text(hjust = 0.5),
                        panel.background = element_rect(fill = "grey") )+
                scale_color_viridis( option="magma")
plot(plot13)


```

```{r Attach30, include=TRUE, echo=FALSE, message= FALSE,  warning = FALSE, results="hide", dev='png', fig.show='hide'}

# # Building a regression model.
# When building the model, I used intuition first. Based on conclussions derived
# at the time of exploring the dataset, a combination of the place and time of SI
# would give a good fit for the number of incidents.
# I tested 5 models, and selected the one with the highest R squared coefficient.

# Model 1:
tempDF12 <- nypdDF %>% group_by(weekDay, boro) %>% summarize( incidents = n())
model1 <- lm(data=tempDF12, formula = incidents ~ weekDay+boro )
rsqModelV <- c( summary(model1)$adj.r.squared  )
formModelV <- c( summary(model1)$call )
#summary(model1) #print at the end.

# Highest R squared 0.93. p values are not great.
# The model does a fare job predicting the total accumulated SI over 2006-2022 based on
# 2 variables: the boro and the day of the week. Save for the case
# of Staten Island, where the model predicts negative incidents on Thursdays, Tuesdays and Wednesdays.

# Now that I have selected a model, I would like to compare it to the real data.
# I will merge the real data with the model estimates first.

weekDayBoro <- paste(tempDF12$weekDay, tempDF12$boro, sep="")

# compModelDF # This data frame merges the real data series with the estimates provided by the model.
estimateV <- model1$fitted.values
compModelDF <- data.frame(tempDF12, weekDayBoro, estimateV)

# plot 16: real vs estimate. Plot at the end of the document.            

# Model 2:
tempDF10 <- nypdDF %>% group_by(year, weekDay, boro ) %>% summarize( incidents = n())
model2 <- lm(data=tempDF10, formula = incidents ~ year+boro+weekDay )
#summary(model2)
rsqModelV <- append( rsqModelV, summary(model2)$adj.r.squared )
formModelV <- append( formModelV, c( summary(model2)$call ) )
# R squared 0.75. Error = 18.5
# Good/high R squared. Lowest p values.

# Model 3:
tempDF11 <- nypdDF %>% group_by(month, boro, weekDay) %>% summarize( incidents = n())
model3 <- lm(data=tempDF11, formula = incidents ~ month+boro+weekDay )
#summary(model3)
rsqModelV <- append( rsqModelV, summary(model3)$adj.r.squared )
formModelV <- append( formModelV, c( summary(model3)$call ) )
# Good/high R squared. Low p values.

# Model 4:
tempDF15 <- nypdDF %>% group_by(year, weekDay,boro,murflag) %>% summarize( incidents = n())
model4 <- lm(data=tempDF15, formula = incidents ~ year+boro+weekDay+murflag )
#summary(model4)
rsqModelV <- append( rsqModelV, summary(model4)$adj.r.squared )
formModelV <- append( formModelV, c( summary(model4)$call ) )
# R squared 0.67.

#Model 5:
tempDF13 <- nypdDF %>% group_by(year, month, boro, weekDay) %>% summarize( incidents = n())
model5 <- lm(data=tempDF13, formula = incidents ~ year+month+boro+weekDay )
#summary(model5)
rsqModelV <- append( rsqModelV, summary( model5 )$adj.r.squared )
formModelV <- append( formModelV, c( summary(model5)$call ) )
# Low R squared 0.29.
```

```{r Attach31, include=TRUE, echo=FALSE, message= FALSE,  warning = FALSE, results="hide", dev='png', fig.show='hide'}

formModelV
#rsqModelV %>% round(2)
```

```{r Attach32, include=TRUE, echo=FALSE, message= FALSE,  warning = FALSE, results="hide", dev='png', fig.show='hide'}

summary(model1)
```

```{r Attach33, include=TRUE, echo=FALSE, message= FALSE,  warning = FALSE, results="hide", dev='png', fig.show='hide'}

plot16 <- compModelDF %>% ggplot( aes( x = weekDayBoro) )+
                        geom_point( aes( y = incidents, shape = boro, color = weekDay), stroke=1,size=2) +
                        geom_point( aes( y = estimateV ), shape = 8, stroke=1 )+
                        theme( legend.position="right", 
                               axis.text.x = element_text(angle = 45, 
                               vjust = 1, 
                               hjust = 1, 
                               size = 5),
                               panel.background = element_rect(fill = "grey") )+
                        scale_color_viridis_d( option="inferno")+
                        labs(title= "NYC Shooting Incidents (2006-2022) -- Real vs (black star '*' ) Estimate.")
plot(plot16)
```

# Executive Summary and Conclussions:
In this section I will be addressing and answering the questions set out in the goals one by one.

### Answer to Question 1: Is there a trend for the number of Shooting Incidents (SI) over the years 2006-2022? Is it trending down or up? Has it been consistently doing so?

SI (Shooting incidents) steadily declined from a high of `r stat1` incidents in
2006 (with `r stat2` categorized as murders), to a low of `r stat3` in
2019 (with `r stat4` resulting in murders). It subsequently increased
sharply to `r stat5` incidents in 2021 (with `r stat6` murders). The
2020/2021 number of SI was twice the number observed in 2019. SI declined in 2022, but remain elevated compared to years prior to the pandemic.

```{r ExecSum1, include=TRUE, echo=FALSE, message= FALSE,  warning = FALSE, ref.label=c("Attach2A"), fig.show=TRUE }

```

`r knitr::fig_chunk('Attach2A', 'png')`

### Answer to Question 2: What is the number of SI in 2022 for each of the different neighborhoods (boros)?

The trend for each individual boro is very similar to the general trend described above. The total SI in 2022 declined in all boros. The boro with the largest number of SI in 2022 was: `r stat7`, with `r stat8` total incidents, and `r stat9` incidents classified as murders. 

```{r ExecSum2, include=TRUE, echo=FALSE, message= FALSE,  warning = FALSE, ref.label=c("Attach2B"), fig.show=TRUE }

```

`r knitr::fig_chunk('Attach2B', 'png')`

The boro with the largest number of SI resulting in murder was `r stat10`, which shows less SI than Brooklyn (`r stat11`), but a higher murder count of `r stat12`, and the highest proportion of murders to total SI (`r stat13`%).


### Answer to Question 3: Is there a monthly trend or pattern? What month in 2022 shows the highest number of SI in each boro? How many SI took place in that month?

The total number of SI has varied across the years, and it varies across months in the same year. The lighter colors appear in the center section (summer months) of the bubble heat map.


```{r ExecSum3, include=TRUE, echo=FALSE, message= FALSE,  warning = FALSE, ref.label=c("Attach2C1"), fig.show=TRUE }
```

`r knitr::fig_chunk('Attach2C1', 'png')`

The chart below shows the distribution of the SI for each month for all years. Each dot represents total SI for that year-month.

```{r ExecSum4, include=TRUE, echo=FALSE, message= FALSE, warning = FALSE, ref.label=c("Attach2C2"), fig.show=TRUE }
```

`r knitr::fig_chunk('Attach2C2', 'png')`

The chart indicates that indeed there is more SI (above the average of `r round( stat15, 0) `) in the following months: `r stat14` (January = 1). The median number of SI across the years 2006-2022 in the month of August is about 180 incidents (about 210 for August).

In the year 2022, the monthly distribution of SI was:

```{r ExecSum5, include=TRUE, echo=FALSE, message= FALSE,  warning = FALSE, ref.label=c("Attach2C3"), fig.show=TRUE }
```

And the average SI for all months of the 2022 was `r stat17`. The top 5 months in 2022 with the highest number of SI are: `r stat16` (January is month 1).


### Question 4: How many SI in the highest month of 2022 resulted in the murder of the victim?

If we were to focus on those incidents resulting in murder in 2022, the data shows a very similar pattern:

```{r ExecSum5, include=TRUE, echo=FALSE, message= FALSE,  warning = FALSE, ref.label=c("Attach2C4"), fig.show=TRUE }
```

`r knitr::fig_chunk("Attach2C4", 'png')`

The top 5 months in 2022 with the highest fatal number of SI were `r stat18`, with an average of `r stat19` fatal SI a month (2022), approximately 1 per day.


### Question 5: Is there a day in the week when SI is higher? What day/s are higher?

The data also shows that the number of SI is higher in certain days of the week. One data point (one dot on the chart) is the total sum of SI on that day of the week in one year. There are 17 dots (one for each year of study) in each day of the week boxplot.

```{r ExecSum50, include=TRUE, echo=FALSE, message= FALSE,  warning = FALSE, ref.label=c("Attach2C50"), fig.show=TRUE }
```

`r knitr::fig_chunk("Attach2C50", 'png')`

The chart shows that SI on Friday, Saturday, Sunday and Monday are above the average of `r avIncWeedDay81` of all days in the week.


### Question 6: What is the long-run average of daily SI for each day of the week? 

The average weekday number of incidents is the total number of SI for that weekday, for all years, divided by the number of that weekday in all years. Take Friday for example on the previous chart (question 5). The median total number of SI across is about 230 on Fridays. Each year has 52 Fridays, hence, the average across all years for 1 Friday will be close to 230/52 = 4. The exact number of Fridays in each year and the exact mean is computed by the code.


```{r ExecSum51, include=TRUE, echo=FALSE, message= FALSE,  warning = FALSE, ref.label=c("Attach2C51"), fig.show=TRUE }
```

`r knitr::fig_chunk("Attach2C51", 'png')`

The most active SI days, on average, are : `r stat20` (Monday is 1), with an average number of SI per day of `r stat21` across all years.


### Question 7: What is the daily average pattern of FATAL shooting incidents?

The weekly long-run average pattern of shooting incidents resulting in murder is very similar to that of total SI:

```{r ExecSum6, include=TRUE, echo=FALSE, message= FALSE,  warning = FALSE, ref.label=c("Attach2C6"), fig.show=TRUE }
```

`r knitr::fig_chunk("Attach2C6", 'png')`

The week days with largest average number of FATAL SI are `r stat22`, and the daily average number of SI is `r stat23` across all years.


### Question 8: is there a pattern of SI in the hour of the day?

SI take place at all hours of the day, but not evenly so. SI are higher in the late hours of the evening of Friday, Saturdays, and Mondays; and in the early hours of the morning of Saturdays and Sundays.

```{r ExecSum7, include=TRUE, echo=FALSE, message= FALSE,  warning = FALSE, ref.label=c("Attach2C70"), fig.show=TRUE }
```

`r knitr::fig_chunk("Attach2C70", 'png')`

The total accumulated SI for each hour of the day, for all years between 2006 and 2022, is an indication of the most active hours for shooting incidents.

```{r ExecSum8, include=TRUE, echo=FALSE, message= FALSE,  warning = FALSE, ref.label=c("Attach2C71"), fig.show=TRUE }
```

`r knitr::fig_chunk("Attach2C71", 'png')`

The most active SI hours are `r maxHourList61`.


### Question 9: What are the most active hours for fatal shooting incidents?

```{r ExecSum9, include=TRUE, echo=FALSE, message= FALSE,  warning = FALSE, ref.label=c("Attach2C72"), fig.show=TRUE }
```

`r knitr::fig_chunk("Attach2C72", 'png')`


The most active hours for SI resulting in the death of the victim are:
`r maxIncH7`


# Building a Regression Model:

Based on the answers to the questions set out in the goals (these drive the conclusion) derived at the time of exploring the dataset, combined with a bit of intuition, the place and time in which SI take place would give a good starting point for a model to fit to the number of accumulated total incidents in the years of study (2006-2022).

I tested 5 models and they include the following variables:

```{r ExecSum10, include=TRUE, echo=FALSE, message= FALSE, warning = FALSE, ref.label=c("Attach31"), fig.show=TRUE }
```

With the following R squared: `r rsqModelV %>% round(2)` (models 1 to 5 respectively, in order.)

The best model shows the highest R squared:
`r rsqModelV[1] %>% round(2)`. The model explains
`r (rsqModelV[1]* 100)%>% round(0)`% of the variance.

This is the summary of the final model:

```{r ExecSum11, include=TRUE, echo=FALSE, message= FALSE, warning = FALSE, ref.label=c("Attach32"), fig.show=TRUE }
```

The model does a fair job predicting the total accumulated SI over 2006-2022 based on 2 variables: the boro and the day of the week (save for the case of Staten Island, where the model predicts negative incidents on Thursdays, Tuesdays and Wednesdays).

```{r ExecSum12, include=TRUE, echo=FALSE, message= FALSE, warning = FALSE, ref.label=c("Attach33"), fig.show=TRUE }
```

`r knitr::fig_chunk("Attach33", 'png')`

# Conclusions and Closing Remarks:
The data suggests that SI have declined prior to 2019, sharply increase during the pandemic (2020 and 2021), and started to decline again in 2022. This holds generally for the five boros of study and individually for each of the boros.

There are clear patterns of SI. SI are higher in the summer months, in the late hours of the evening of Fridays, Saturdays, and Mondays; and in the early hours of the morning of Saturdays and Sundays. Fatal SI --which result in the death of the victim--, follow a similar pattern.
The boros most affected are Brooklyn --with the highest SI count-- and Bronx --with the highest of fatal SI--. The proportion of fatal SI to total SI is 18% in all boros except Bronx where it is 23%.

A regression model with two variables --boro, and week day-- is able to explain 93% of the variance of accumulated SI over the years of study. This model does not do well in places where SI is very low, like in Staten Island.



# Attachment 1 Code: Importing and cleaning the data.

```{r Attach1Code, ref.label=c("Attach1"), eval=FALSE, message= FALSE,  warning = FALSE}

```

# Attachment 2 Code: Analysis.

```{r Attach2Code, ref.label=c("Attach2A","Attach2B","Attach2C1","Attach2C2","Attach2C3","Attach2C4","Attach2C50","Attach2C51","Attach2C6","Attach2C70","Attach2C71","Attach2C72"), eval=FALSE, message= FALSE,  warning = FALSE}

```

# Attachment 3 Code: Regression Model.

```{r Attach3Code, ref.label=c("Attach30","Attach31","Attach32", "Attach33"), eval=FALSE, message= FALSE,  warning = FALSE}
```

```{r, include = TRUE}
        sessionInfo()
```
